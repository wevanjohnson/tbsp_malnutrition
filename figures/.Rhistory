modcombat
combined_India.combatSeqCorrect <- ComBat_seq(assay(indata, "counts"),
colData(indata)$batch, group=NULL,
covar_mod=modcombat)
?mkAssay
mkAssay(indata, input_name = "combatseq", log=T)
assay(indata, "combatseq") <- ComBat_seq(assay(indata, "counts"),
colData(indata)$batch, group=NULL,
covar_mod=modcombat)
mkAssay(indata, input_name = "combatseq", log=T)
indata <- mkAssay(indata, input_name = "combatseq", log=T)
saveRDS(indata, file = "~/projects/malnutrition/indata_SCE_batchcorrect.rds")
library(SummarizedExperiment)
library(TBSignatureProfiler)
library(ComplexHeatmap)
setwd("~/projects/malnutrition/indata_SCE_batchcorrect.rds")
mal_input <- readRDS("~/projects/malnutrition/indata_SCE_batchcorrect.rds")
setwd("~/projects/malnutrition/")
dim(mal_input)
mal_input <- mal_input[ , which(colData(mal_input)$bmi_cat2 == "mal")]
dim(mal_input)
mal_input$TB.status
factor(paste(mal_input$status))
mal_input$TB.status <- factor(paste(mal_input$status))
names(TBsignatures)
mal_input <- mal_input[ , which(colData(mal_input)$bmi_cat2 == "mal")]
mal_input$TB.status <- factor(paste(mal_input$status))
siglist_mal <- names(TBsignatures)
ssgsea_res <- runTBsigProfiler(mal_input, useAssay = "log_cpm",
algorithm = "ssGSEA")
gsva_res <- runTBsigProfiler(mal_input, useAssay = "log_cpm",
algorithm = "GSVA")
plage_res <- runTBsigProfiler(mal_input, useAssay = "log_cpm",
algorithm = "PLAGE")
setwd("~/projects/malnutrition/figures")
special_red <- RColorBrewer::brewer.pal(3, "Set1")[1]
special_blue <- RColorBrewer::brewer.pal(3, "Set1")[2]
col.me <- viridis::viridis(15)
colorList <- list("status" = setNames(c(special_red,
special_blue),
c("TB_mal", "LTBI_mal")))
png(filename = "genes_in_5plus.png", width = 8, height = 7,
units = "in", res = 150)
genesin5ormore <- names(sort(table(unlist(TBsignatures)),
decreasing = TRUE)[sort(table(unlist(TBsignatures)),
decreasing = TRUE) > 4])
geneoverlapdf <- data.frame(row.names = genesin5ormore)
for(i in names(TBsignatures)){
geneoverlapdf[,i] <- ifelse(rownames(geneoverlapdf)%in% TBsignatures[[i]],
"Yes", "No")
}
geneoverlapdf <- geneoverlapdf[,order(colSums(geneoverlapdf == "Yes"),
decreasing = TRUE)]
geneoverlapdf <- geneoverlapdf[order(rowSums(geneoverlapdf == "Yes"),
decreasing = TRUE),]
draw(Heatmap(t(as.matrix(geneoverlapdf)), col=c("white", special_blue),
row_names_gp = gpar(fontsize = 8),
column_names_gp = gpar(fontsize = 8),
rect_gp = gpar(col="grey", lty=1),
name = "Gene in Signature"),
heatmap_legend_side = "bottom")
dev.off()
overlap_matrix <- matrix(0, nrow = length(TBsignatures),
ncol = length(TBsignatures))
for (i in 1:length(TBsignatures)){
for (j in 1:length(TBsignatures)){
overlap_matrix[i, j] <- sum(
!is.na(match(TBsignatures[[i]],
TBsignatures[[j]]))) / length(TBsignatures[[i]])
}
}
rownames(overlap_matrix) <- colnames(overlap_matrix) <- names(TBsignatures)
over_pct <- round(overlap_matrix, 3) * 100
write.csv(overlap_matrix, file = "overlap.csv", quote = FALSE)
png(filename = "Heatmap_ssGSEA.png", width = 12, height = 10, units = "in",
res = 150)
signatureHeatmap(ssgsea_res, name = "ssGSEA",
signatureColNames = names(TBsignatures),
annotationColNames = c("status"),
showColumnNames = FALSE, scale = TRUE,
choose_color = col.me,
colList = colorList)
dev.off()
png(filename = "Heatmap_GSVA.png", width = 12, height = 10, units = "in",
res = 150)
signatureHeatmap(gsva_res, name = "GSVA",
signatureColNames = names(TBsignatures),
annotationColNames = c("status"),
showColumnNames = FALSE, scale = TRUE,
choose_color = col.me,
colList = colorList)
dev.off()
signatureGeneHeatmap(gsva_res,"log_cpm", "Suliman_4")
?signatureGeneHeatmap
signatureGeneHeatmap(gsva_res,"log_cpm", sigGenes=TBsignatures[["Suliman_4"]])
signatureGeneHeatmap(gsva_res,"log_cpm", sigGenes=TBsignatures[["Suliman_RISK_4"]])
signatureGeneHeatmap(gsva_res,"log_cpm", sigGenes=TBsignatures[["Suliman_4"]])
signatureGeneHeatmap(gsva_res,"log_cpm", sigGenes=TBsignatures[["Suliman_RISK_4"]])
TBsignatures[["Suliman_RISK_4"]]
signatureGeneHeatmap(gsva_res,"log_cpm", sigGenes=TBsignatures[["Suliman_RISK_4"]])
setwd("~/projects/malnutrition/")
mal_input <- readRDS("~/projects/malnutrition/indata_SCE_batchcorrect.rds")
# mal only
mal_input <- mal_input[ , which(colData(mal_input)$bmi_cat2 == "mal")]
mal_input$TB.status <- factor(paste(mal_input$status))
siglist_mal <- names(TBsignatures)
ssgsea_res <- runTBsigProfiler(mal_input, useAssay = "log_cpm",
algorithm = "ssGSEA")
gsva_res <- runTBsigProfiler(mal_input, useAssay = "log_cpm",
algorithm = "GSVA")
plage_res <- runTBsigProfiler(mal_input, useAssay = "log_cpm",
algorithm = "PLAGE")
# Change wd to store plots
setwd("~/projects/malnutrition/figures")
# some things related to colors
special_red <- RColorBrewer::brewer.pal(3, "Set1")[1]
special_blue <- RColorBrewer::brewer.pal(3, "Set1")[2]
# COLORS FOR HEATMAP
col.me <- viridis::viridis(15)
colorList <- list("status" = setNames(c(special_red,
special_blue),
c("TB_mal", "LTBI_mal")))
# colorList <- list("status" = setNames(c(viridis::magma(20)[12],
#                                         viridis::magma(20)[18]),
#                                       c("TB_mal", "LTBI_mal")))
# Methods Figure 1: table of genes in five or more sigs, decending order
png(filename = "genes_in_5plus.png", width = 8, height = 7,
units = "in", res = 150)
genesin5ormore <- names(sort(table(unlist(TBsignatures)),
decreasing = TRUE)[sort(table(unlist(TBsignatures)),
decreasing = TRUE) > 4])
geneoverlapdf <- data.frame(row.names = genesin5ormore)
for(i in names(TBsignatures)){
geneoverlapdf[,i] <- ifelse(rownames(geneoverlapdf)%in% TBsignatures[[i]],
"Yes", "No")
}
geneoverlapdf <- geneoverlapdf[,order(colSums(geneoverlapdf == "Yes"),
decreasing = TRUE)]
geneoverlapdf <- geneoverlapdf[order(rowSums(geneoverlapdf == "Yes"),
decreasing = TRUE),]
draw(Heatmap(t(as.matrix(geneoverlapdf)), col=c("white", special_blue),
row_names_gp = gpar(fontsize = 8),
column_names_gp = gpar(fontsize = 8),
rect_gp = gpar(col="grey", lty=1),
name = "Gene in Signature"),
heatmap_legend_side = "bottom")
dev.off()
overlap_matrix <- matrix(0, nrow = length(TBsignatures),
ncol = length(TBsignatures))
for (i in 1:length(TBsignatures)){
for (j in 1:length(TBsignatures)){
overlap_matrix[i, j] <- sum(
!is.na(match(TBsignatures[[i]],
TBsignatures[[j]]))) / length(TBsignatures[[i]])
}
}
rownames(overlap_matrix) <- colnames(overlap_matrix) <- names(TBsignatures)
over_pct <- round(overlap_matrix, 3) * 100
write.csv(overlap_matrix, file = "overlap.csv", quote = FALSE)
png(filename = "Heatmap_ssGSEA.png", width = 12, height = 10, units = "in",
res = 150)
signatureHeatmap(ssgsea_res, name = "ssGSEA",
signatureColNames = names(TBsignatures),
annotationColNames = c("status"),
showColumnNames = FALSE, scale = TRUE,
choose_color = col.me,
colList = colorList)
dev.off()
# Supplementary Figure 1. Heatmap of all signatures on one heatmap (GSVA)------
png(filename = "Heatmap_GSVA.png", width = 12, height = 10, units = "in",
res = 150)
signatureHeatmap(gsva_res, name = "GSVA",
signatureColNames = names(TBsignatures),
annotationColNames = c("status"),
showColumnNames = FALSE, scale = TRUE,
choose_color = col.me,
colList = colorList)
dev.off()
signatureGeneHeatmap(gsva_res,"log_cpm", sigGenes=TBsignatures[["Suliman_RISK_4"]])
dim(indata)
setwd("~/projects/malnutrition/")
mal_input <- readRDS("~/projects/malnutrition/indata_SCE_batchcorrect.rds")
dim(mal_input)
rownames(mal_input)
which(rownames(mal_input)=="SEPT4")
grep(rownames(mal_input), "sept")
grep(rownames(mal_input), "sept")
?grep
grep("SEPT4",rownames(mal_input))
grep("SEPT",rownames(mal_input))
rownames(mal_input)[grep("SEPT",rownames(mal_input))]
grep("SEPTIN4",rownames(mal_input))
rownames(mal_input)[grep("SEPTIN4",rownames(mal_input))]
library(SummarizedExperiment)
library(TBSignatureProfiler)
library(ComplexHeatmap)
TBsignatures$'Suliman_RISK_4' <- c("GAS6","SEPTIN4","CD1C","BLK")
signatureGeneHeatmap(gsva_res,"log_cpm", sigGenes=TBsignatures[["Suliman_RISK_4"]])
mal_input <- readRDS("~/projects/malnutrition/indata_SCE_batchcorrect.rds")
mal_input <- mal_input[ , which(colData(mal_input)$bmi_cat2 == "mal")]
mal_input$TB.status <- factor(paste(mal_input$status))
siglist_mal <- names(TBsignatures)
ssgsea_res <- runTBsigProfiler(mal_input, useAssay = "log_cpm",
algorithm = "ssGSEA")
gsva_res <- runTBsigProfiler(mal_input, useAssay = "log_cpm",
algorithm = "GSVA")
plage_res <- runTBsigProfiler(mal_input, useAssay = "log_cpm",
algorithm = "PLAGE")
setwd("~/projects/malnutrition/figures")
# some things related to colors
special_red <- RColorBrewer::brewer.pal(3, "Set1")[1]
special_blue <- RColorBrewer::brewer.pal(3, "Set1")[2]
# COLORS FOR HEATMAP
col.me <- viridis::viridis(15)
colorList <- list("status" = setNames(c(special_red,
special_blue),
c("TB_mal", "LTBI_mal")))
# colorList <- list("status" = setNames(c(viridis::magma(20)[12],
#                                         viridis::magma(20)[18]),
#                                       c("TB_mal", "LTBI_mal")))
# Methods Figure 1: table of genes in five or more sigs, decending order
png(filename = "genes_in_5plus.png", width = 8, height = 7,
units = "in", res = 150)
genesin5ormore <- names(sort(table(unlist(TBsignatures)),
decreasing = TRUE)[sort(table(unlist(TBsignatures)),
decreasing = TRUE) > 4])
geneoverlapdf <- data.frame(row.names = genesin5ormore)
for(i in names(TBsignatures)){
geneoverlapdf[,i] <- ifelse(rownames(geneoverlapdf)%in% TBsignatures[[i]],
"Yes", "No")
}
geneoverlapdf <- geneoverlapdf[,order(colSums(geneoverlapdf == "Yes"),
decreasing = TRUE)]
geneoverlapdf <- geneoverlapdf[order(rowSums(geneoverlapdf == "Yes"),
decreasing = TRUE),]
draw(Heatmap(t(as.matrix(geneoverlapdf)), col=c("white", special_blue),
row_names_gp = gpar(fontsize = 8),
column_names_gp = gpar(fontsize = 8),
rect_gp = gpar(col="grey", lty=1),
name = "Gene in Signature"),
heatmap_legend_side = "bottom")
dev.off()
overlap_matrix <- matrix(0, nrow = length(TBsignatures),
ncol = length(TBsignatures))
for (i in 1:length(TBsignatures)){
for (j in 1:length(TBsignatures)){
overlap_matrix[i, j] <- sum(
!is.na(match(TBsignatures[[i]],
TBsignatures[[j]]))) / length(TBsignatures[[i]])
}
}
rownames(overlap_matrix) <- colnames(overlap_matrix) <- names(TBsignatures)
over_pct <- round(overlap_matrix, 3) * 100
write.csv(overlap_matrix, file = "overlap.csv", quote = FALSE)
png(filename = "Heatmap_ssGSEA.png", width = 12, height = 10, units = "in",
res = 150)
signatureHeatmap(ssgsea_res, name = "ssGSEA",
signatureColNames = names(TBsignatures),
annotationColNames = c("status"),
showColumnNames = FALSE, scale = TRUE,
choose_color = col.me,
colList = colorList)
dev.off()
png(filename = "Heatmap_GSVA.png", width = 12, height = 10, units = "in",
res = 150)
signatureHeatmap(gsva_res, name = "GSVA",
signatureColNames = names(TBsignatures),
annotationColNames = c("status"),
showColumnNames = FALSE, scale = TRUE,
choose_color = col.me,
colList = colorList)
dev.off()
png(filename = "AUC_boxplot_ssGSEA.png", width = 10, height = 10,
units = "in", res = 150)
signatureBoxplot(ssgsea_res, name="ssGSEA",
signatureColNames = names(TBsignatures),
annotationColName = c("status"),
fill_colors = c(special_blue, special_red))
dev.off()
png(filename = "score_boxplot_ssGSEA.png", width = 7, height = 5,
units = "in", res = 150)
par(mar = c(7,2,2,1))
compareBoxplots(ssgsea_res, signatureColNames = names(TBsignatures),
annotationColName = "status", pb.show = TRUE,
name = "ssGSEA", rotateLabels = TRUE,
fill.col = special_red)
dev.off()
png(filename = "AUC_boxplot_GSVA.png", width = 10, height = 10, units = "in",
res = 150)
signatureBoxplot(gsva_res, signatureColNames = names(TBsignatures),
annotationColName = c("status"), name = "GSVA",
fill_colors = c(special_blue, special_red),
rotateLabels = TRUE)
dev.off()
png(filename = "score_boxplot_GSVA.png", width = 7, height = 5,
units = "in", res = 150)
par(mar = c(7,2,2,1))
compareBoxplots(gsva_res, signatureColNames = names(TBsignatures),
annotationColName = "status", pb.show = TRUE,
name = "GSVA", fill.col = special_red,
rotateLabels = TRUE)
dev.off()
png(filename = "Sambarey_HIV_10.png", width = 6, height = 4, units = "in",
res = 150)
signatureGeneHeatmap(ssgsea_res, useAssay = "combat",
sigGenes = TBsignatures[["Sambarey_HIV_10"]],
name = "Sambarey_HIV_10", signatureColNames = NULL,
annotationColNames = c("status"), scale = TRUE,
choose_color = col.me,
colList = colorList,
showColumnNames = FALSE)
dev.off()
png(filename = "Sambarey_HIV_10.png", width = 6, height = 4, units = "in",
res = 150)
signatureGeneHeatmap(ssgsea_res, useAssay = "log_cpm",
sigGenes = TBsignatures[["Sambarey_HIV_10"]],
name = "Sambarey_HIV_10", signatureColNames = NULL,
annotationColNames = c("status"), scale = TRUE,
choose_color = col.me,
colList = colorList,
showColumnNames = FALSE)
dev.off()
png(filename = "Sambarey_HIV_10.png", width = 6, height = 4, units = "in",
res = 150)
signatureGeneHeatmap(ssgsea_res, useAssay = "log_cpm",
sigGenes = TBsignatures[["Sambarey_HIV_10"]],
name = "Sambarey_HIV_10", signatureColNames = NULL,
annotationColNames = c("status"), scale = TRUE,
choose_color = col.me,
colList = colorList,
showColumnNames = FALSE)
dev.off()
png(filename = "Thompson_9.png", width = 6, height = 4, units = "in",
res = 150)
signatureGeneHeatmap(ssgsea_res, useAssay = "log_cpm",
TBsignatures[["Thompson_9"]],
name = "Thompson_9", signatureColNames = NULL,
choose_color = col.me,
colList = colorList,
annotationColNames = c("status"),
showColumnNames = FALSE)
dev.off()
png(filename = "Lee_4.png", width = 6, height = 4, units = "in",
res = 150)
signatureGeneHeatmap(ssgsea_res, useAssay = "log_cpm",
TBsignatures[["Lee_4"]],
name = "Lee_4", signatureColNames = NULL,
choose_color = col.me,
colList = colorList,
annotationColNames = c("status"),
showColumnNames = FALSE)
dev.off()
png(filename = "Maertzdorf_4.png", width = 6, height = 4, units = "in",
res = 150)
signatureGeneHeatmap(ssgsea_res, useAssay = "log_cpm",
TBsignatures[["Maertzdorf_4"]],
name = "Maertzdorf_4", signatureColNames = NULL,
choose_color = col.me,
colList = colorList,
annotationColNames = c("status"),
showColumnNames = FALSE)
dev.off()
png(filename = "ssgsea_ROC.png", width = 11, height = 9, units = "in",
res = 150)
signatureROCplot_CI(ssgsea_res, signatureColNames = names(TBsignatures),
scale = TRUE, annotationColName = "status",
name =
"ROC Plots for Gene Signatures, 95% Confidence, ssGSEA",
nrow = 6, ncol = 6, choose_colors = c(special_blue,
"gray50",
"gray79"))
dev.off()
# GSVA
png(filename = "gsva_ROC.png", width = 11, height = 9, units = "in",
res = 150)
signatureROCplot_CI(gsva_res, signatureColNames = names(TBsignatures),
scale = TRUE, annotationColName = "status",
name =
"ROC Plots for Gene Signatures, 95% Confidence, GSVA",
nrow = 6, ncol = 6, choose_colors = c(special_blue,
"gray50",
"gray79"),
)
dev.off()
# Supplementary figure XX: TableAUC for ssGSEA -------------------------------
out.ssgsea <- tableAUC(ssgsea_res, "status", names(TBsignatures),
output = "data.frame")
out.ssgsea
write.csv(out.ssgsea, file = "ssGSEA_TableAUC.csv")
# Supplementary figure XX: TableAUC for GSVA -------------------------------
out.gsva <- tableAUC(gsva_res, "status", names(TBsignatures), output = "data.frame")
# Differential Expression Clustering Heatmap
mat <- readRDS("DiffExp_matrix_mal.RDS")
df_mal <- readRDS("DiffExp_annot_mal.RDS")
annot <- HeatmapAnnotation(df = df_mal, col = list(TB_status = c(
"TB" = special_red, "LTBI" = special_blue)))
png(filename = "Heatmap_DIFF_EXP.png", width = 12, height = 10, units = "in",
res = 150)
Heatmap(mat, show_row_names = F,
show_column_names = F,
top_annotation = annot,
col = col.me,
name = "Diff. Exp")
dev.off()
png(filename = "AUC_boxplot_.png", width = 10, height = 10, units = "in",
res = 150)
signatureBoxplot(plage_res, signatureColNames = names(TBsignatures),
annotationCPLAGEolName = c("status"), name = "PLAGE",
fill_colors = c(special_blue, special_red),
rotateLabels = TRUE)
dev.off()
png(filename = "score_boxplot_PLAGE.png", width = 7, height = 5,
units = "in", res = 150)
par(mar = c(7,2,2,1))
compareBoxplots(plage_res, signatureColNames = names(TBsignatures),
annotationColName = "status", pb.show = TRUE,
name = "PLAGE", fill.col = special_red,
rotateLabels = TRUE)
dev.off()
png(filename = "AUC_boxplot_.png", width = 10, height = 10, units = "in",
res = 150)
signatureBoxplot(plage_res, signatureColNames = names(TBsignatures),
annotationColName = c("status"), name = "PLAGE",
fill_colors = c(special_blue, special_red),
rotateLabels = TRUE)
dev.off()
png(filename = "score_boxplot_PLAGE.png", width = 7, height = 5,
units = "in", res = 150)
par(mar = c(7,2,2,1))
compareBoxplots(plage_res, signatureColNames = names(TBsignatures),
annotationColName = "status", pb.show = TRUE,
name = "PLAGE", fill.col = special_red,
rotateLabels = TRUE)
dev.off()
png(filename = "Heatmap_PLAGE.png", width = 12, height = 10, units = "in",
res = 150)
signatureHeatmap(plage_res, name = "PLAGE",
signatureColNames = names(TBsignatures),
annotationColNames = c("status"),
showColumnNames = FALSE, scale = TRUE,
choose_color = col.me,
colList = colorList)
dev.off()
out.ssgsea <- tableAUC(ssgsea_res, "status", names(TBsignatures),
output = "data.frame")
write.csv(out.ssgsea, file = "ssgsea_tableAUC.csv", quote = FALSE)
source('~/projects/malnutrition/paper_figures_script.R', echo=TRUE)
TBSigh
TBsignatures$Lee_4
png(filename = "AUC_boxplot_.png", width = 10, height = 10, units = "in",
res = 150)
signatureBoxplot(plage_res, signatureColNames = names(TBsignatures),
annotationCPLAGEolName = c("status"), name = "PLAGE",
fill_colors = c(special_blue, special_red),
rotateLabels = TRUE)
dev.off()
grep("ASUN",rownames(mal_input))
grep("ASUN",rownames(mal_input))
grep("ASU",rownames(mal_input))
grep("INTS13",rownames(mal_input))
TBsignatures$Lee_4
source('~/projects/malnutrition/paper_figures_script.R', echo=TRUE)
source('~/projects/malnutrition/paper_figures_script.R', echo=TRUE)
source('~/projects/malnutrition/paper_figures_script.R', echo=TRUE)
png(filename = "AUC_boxplot_.png", width = 10, height = 10, units = "in",
res = 150)
signatureBoxplot(plage_res, signatureColNames = names(TBsignatures),
annotationColName = c("status"), name = "PLAGE",
fill_colors = c(special_blue, special_red),
rotateLabels = TRUE)
dev.off()
# Supplementary Figure 6b. PLAGE results --------------------------------------
png(filename = "score_boxplot_PLAGE.png", width = 7, height = 5,
units = "in", res = 150)
par(mar = c(7,2,2,1))
compareBoxplots(plage_res, signatureColNames = names(TBsignatures),
annotationColName = "status", pb.show = TRUE,
name = "PLAGE", fill.col = special_red,
rotateLabels = TRUE)
dev.off()
# Supplementary Figure 4. Heatmap of all signatures on one heatmap (PLAGE)-----
png(filename = "Heatmap_PLAGE.png", width = 12, height = 10, units = "in",
res = 150)
signatureHeatmap(plage_res, name = "PLAGE",
signatureColNames = names(TBsignatures),
annotationColNames = c("status"),
showColumnNames = FALSE, scale = TRUE,
choose_color = col.me,
colList = colorList)
dev.off()
# Supplementary Table 1: TableAUC for ssGSEA -------------------------------
out.ssgsea <- tableAUC(ssgsea_res, "status", names(TBsignatures),
output = "data.frame")
write.csv(out.ssgsea, file = "ssgsea_tableAUC.csv", quote = FALSE)
# Change wd back to original directory
setwd("~/projects/malnutrition/")
1/12
1/48
source('~/projects/malnutrition/paper_figures_script.R', echo=TRUE)
View(out.ssgsea)
mat <- readRDS("~/projects/malnutrition/DiffExp_matrix_mal.RDS")
df_mal <- readRDS("~/projects/malnutrition/DiffExp_annot_mal.RDS")
annot <- HeatmapAnnotation(df = df_mal, col = list(TB_status = c(
"TB" = special_red, "LTBI" = special_blue)))
png(filename = "Heatmap_DIFF_EXP.png", width = 12, height = 10, units = "in",
res = 150)
Heatmap(mat, show_row_names = F,
show_column_names = F,
top_annotation = annot,
col = col.me,
name = "Diff. Exp")
dev.off()
